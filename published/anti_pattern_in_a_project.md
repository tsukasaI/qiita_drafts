# ほんとにあったアンチパターン

エンジニアとして勉強していると「設計はこうするべき」「命名はこうするべき」「コーディングスタイルはこうするべき」など様々なパターンを学習するが、プロジェクトによっては守られていないことがある。

今回はほんとにあった気になったものたちを記憶ベースでまとめて、さらにどのようにするのが良いかまで書きます。

## 命名

### テーブル名の統一性

テーブル名やカラム名についてそもそも統一がされていなかった。

テーブル名については単数形と複数形が混在していた。

どちらが正しいかは考え方によるが同一プロジェクト内では片方に統一をして、新しいテーブルを作る場合はそのルールに従うようにすると良い。

### カラム名

突然の質問になってしまいますが、`start_date`というカラム名はどのようなデータ型を持っていると思いますか？

[MySQLのドキュメント](https://dev.mysql.com/doc/refman/8.0/ja/datetime.html)では`DATE 型は、日付部分を含むが時間部分は含まない値に使用されます。 MySQL は、DATE 値を'YYYY-MM-DD'形式で取得して表示します。 ` という記載があります。

つまりサンプルの値としては'2024-07-01'という値が入ることを私は期待していました。

が実際には`datetime`で実装されていて、'2024-07-01 00:00:00'という値が入っていました。

カラム名や変数名に関しては「名は体を表す」ということを意識して、その変数がどのような値を持つ**読む人の気持ちになって**命名すると良い。

## コーディング

### ifのネスト

ifのネストが深いことが多かった。


基本的にはネストしていない方が読みやすいとされている。

一方でGoのエラーハンドリングは以下のよう関数やメソッドから返り値としてエラーを返し、それをハンドリングすることが多い。

```go
a := someFunc()
if a {
    err := anotherFunc()
    if err != nil {
        return err
    }
}
```

これがあるif文の中で行われるとネストが深くなってしまう。

この場合はearly returnを使うと良い。

```go
a := someFunc()
if !a {
    return nil // もしくは別の処理
}
err := anotherFunc()
if err != nil {
    return err
}
```

## 設計

### N+1問題

[この記事](https://qiita.com/tsukasaI/items/8ff1a50315297725f49c)でも解説しているがDBに負荷をかける問題がある。

解決方法は上記記事を参照してほしい。

### REST APIに反した設計

REST APIではあるリソースの一覧を取得する場合はGETでリクエストを送ることが一般的である。

が一覧取得APIがPOSTでコールされていた。

お作法には従いましょう。

### DIされているところとされていないところがある

Dependency Injection（DI）は依存性の注入という意味で、依存性を注入することでテストしやすくするための手法である。

クリーンアーキテクチャなどでよく使われ、usecase層やrepository層においてDIを行うことが多い。

例としては以下のようなコードがある。

```go
type SomeService struct {
    db *sql.DB
}

func NewSomeService(dsn string) *SomeService {
    return &SomeService{
        db: sql.Open("mysql", dsn),
    }
}
```

このSomeServiceはdsnを本番稼働する時には商用のDB、テスト時にはテスト用環境に接続することができる。

これをテスト対象のメソッドや関数内に書いてしっていてとテストが難しくなっていた。

とにかく外部注入可能なものは外部から注入しましょう。

## テスト

とにかくテストがされていない。テストコードが存在しない。

テストコードが存在していてもケースが不十分でバグを検知するタイミングが遅れることがあった。

テストは書こう。

最初にテストを書くとあとの開発が楽になる。

## ドキュメント

ドキュメントは存在しない

ドキュメントは書こう。

どれだけ急いでいてもおおよその動きやインターフェースの責務をまとめておくと後の人が助かる。

ドキュメントは書こう。
